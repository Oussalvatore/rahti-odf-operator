From: Oussama Bekkouche <oussabe@csc.fi>
Date: Wed Apr 3 12:43:58 2024 +0300
Subject: [PATCH] Deployment workflow

---
diff --git a/.github/workflows/build-and-push.yaml b/.github/workflows/build-and-push.yaml
new file mode 100644
index 00000000..d4e5a57d
--- /dev/null
+++ b/.github/workflows/build-and-push.yaml
@@ -0,0 +1,30 @@
+---
+on: push
+
+jobs:
+  docker-push:
+    runs-on: ubuntu-latest
+    steps:
+    - uses: actions/checkout@v4
+      with:
+        fetch-depth: 0
+
+    - uses: actions/setup-go@v5
+      with:
+        go-version-file: go.mod
+
+    - uses: docker/login-action@v2
+      with:
+        registry: docker.io
+        username: ${{ secrets.DOCKER_USER_NAME }}
+        password: ${{ secrets.DOCKER_TOKEN }}
+
+    - name: Build and push docker images
+      env:
+        IMAGE_REGISTRY: docker.io
+        REGISTRY_NAMESPACE: oussabe
+        IMAGE_TAG: latest
+      run: |
+        make docker-build docker-push
+        make bundle-build bundle-push
+        make catalog-build catalog-push
\ No newline at end of file
diff --git a/.github/workflows/codespell.yaml b/.github/workflows/codespell.yaml
deleted file mode 100644
index ae0dade9..00000000
--- a/.github/workflows/codespell.yaml
+++ /dev/null
@@ -1,23 +0,0 @@
----
-name: codespell
-
-on:
-  push:
-    branches: ['main', 'release-*']
-  pull_request:
-    branches: ['*']
-
-jobs:
-  codespell:
-    runs-on: ubuntu-latest
-    steps:
-    - uses: actions/checkout@v3
-      with:
-        fetch-depth: 0
-
-    - uses: codespell-project/actions-codespell@master
-      with:
-        exclude_file: go.sum
-        check_filenames: true
-        check_hidden: true
-        skip: vendor
diff --git a/.github/workflows/commitlint.yaml b/.github/workflows/commitlint.yaml
deleted file mode 100644
index 45de14c6..00000000
--- a/.github/workflows/commitlint.yaml
+++ /dev/null
@@ -1,26 +0,0 @@
----
-name: commitlint
-
-on:
-  push:
-    branches: ['main', 'release-*']
-  pull_request:
-    branches: ['*']
-
-jobs:
-  commitlint:
-    runs-on: ubuntu-latest
-    steps:
-    - uses: actions/checkout@v3
-      with:
-        fetch-depth: 0
-
-    - uses: wagoid/commitlint-github-action@v5
-      with:
-        configFile: './.github/workflows/conf/commitlintrc.json'
-        helpURL: |
-          Some helpful links
-          Contribution Guide -> https://github.com/red-hat-storage/odf-operator/blob/main/CONTRIBUTING.md#commit-structure
-          Naming Conventions -> https://commitlint.js.org/#/concepts-commit-conventions
-          Rules -> https://commitlint.js.org/#/reference-rules
-          How to Write a Good Git Commit Message -> https://chris.beams.io/posts/git-commit
diff --git a/.github/workflows/conf/commitlintrc.json b/.github/workflows/conf/commitlintrc.json
deleted file mode 100644
index a08c3414..00000000
--- a/.github/workflows/conf/commitlintrc.json
+++ /dev/null
@@ -1,87 +0,0 @@
-{
-    "extends": [
-        "@commitlint/config-conventional"
-    ],
-    "rules": {
-        "body-case": [
-            0,
-            "always",
-            "lower-case"
-        ],
-        "body-empty": [
-            1,
-            "never"
-        ],
-        "body-leading-blank": [
-            2,
-            "always"
-        ],
-        "body-max-line-length": [
-            1,
-            "always",
-            72
-        ],
-        "footer-leading-blank": [
-            2,
-            "always"
-        ],
-        "header-case": [
-            0,
-            "always",
-            "lower-case"
-        ],
-        "header-full-stop": [
-            2,
-            "never",
-            "."
-        ],
-        "header-max-length": [
-            2,
-            "always",
-            72
-        ],
-        "signed-off-by": [
-            2,
-            "always",
-            "Signed-off-by:"
-        ],
-        "subject-case": [
-            0,
-            "always",
-            "lower-case"
-        ],
-        "subject-empty": [
-            2,
-            "never"
-        ],
-        "type-case": [
-            0,
-            "always",
-            "lower-case"
-        ],
-        "type-empty": [
-            2,
-            "never"
-        ],
-        "type-enum": [
-            2,
-            "always",
-            [
-                "action",
-                "api",
-                "bundle",
-                "catalog",
-                "ci",
-                "console",
-                "controllers",
-                "docs",
-                "dockerfile",
-                "godeps",
-                "hack",
-                "makefile",
-                "metrics",
-                "test"
-            ]
-        ]
-    }
-}
diff --git a/.github/workflows/conf/yamllint.yaml b/.github/workflows/conf/yamllint.yaml
deleted file mode 100644
index a2e33460..00000000
--- a/.github/workflows/conf/yamllint.yaml
+++ /dev/null
@@ -1,34 +0,0 @@
----
-extends: default
-yaml-files:
-  - '*.yaml'
-  - '*.yml'
-  - '.yamllint'
-ignore: |
-  vendor
-rules:
-  braces: enable
-  brackets: enable
-  colons: enable
-  commas: enable
-  comments: disable
-  comments-indentation:
-    level: warning
-  document-end: disable
-  document-start: disable
-  empty-lines:
-    max-start: 1
-  empty-values: disable
-  hyphens: enable
-  indentation: disable
-  key-duplicates: enable
-  key-ordering: disable
-  line-length: disable
-  new-line-at-end-of-file: enable
-  new-lines: enable
-  octal-values: disable
-  quoted-strings: disable
-  trailing-spaces: enable
-  truthy:
-    level: warning
-    allowed-values: ['true', 'false', 'on']
diff --git a/.github/workflows/dependencies.yaml b/.github/workflows/dependencies.yaml
deleted file mode 100644
index e4998d31..00000000
--- a/.github/workflows/dependencies.yaml
+++ /dev/null
@@ -1,18 +0,0 @@
----
-name: github
-
-on:
-  pull_request_target:
-    types:
-      - opened
-      - edited
-      - reopened
-      - synchronize
-
-jobs:
-  dependencies:
-    runs-on: ubuntu-latest
-    steps:
-    - uses: z0al/dependent-issues@v1
-      env:
-        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
diff --git a/.github/workflows/docker-build.yaml b/.github/workflows/docker-build.yaml
deleted file mode 100644
index 6669cf33..00000000
--- a/.github/workflows/docker-build.yaml
+++ /dev/null
@@ -1,74 +0,0 @@
----
-name: image-builder
-
-on:
-  push:
-    branches: ['main', 'release-*']
-  pull_request:
-    branches: ['*']
-
-jobs:
-  docker-build:
-    runs-on: ubuntu-latest
-    strategy:
-      fail-fast: false
-      matrix:
-        go: ["1.20", "1.21"]
-    steps:
-    - uses: actions/setup-go@v4
-      with:
-        go-version: ${{ matrix.go }}
-
-    - uses: actions/checkout@v3
-      with:
-        fetch-depth: 0
-
-    - name: Build operator docker image
-      run: make docker-build
-
-  bundle-build:
-    runs-on: ubuntu-latest
-    strategy:
-      fail-fast: false
-      matrix:
-        go: ["1.20", "1.21"]
-    steps:
-    - uses: actions/setup-go@v4
-      with:
-        go-version: ${{ matrix.go }}
-
-    - uses: actions/checkout@v3
-      with:
-        fetch-depth: 0
-
-    - name: Build operator bundle docker image
-      run: |
-        make bundle-build
-        msg='Uncommitted bundle changes. run `make bundle` and commit results.'
-        # We are using `--ignore-matching-lines` flag with the pattern `createdAt`
-        # to exclude lines with the timestamp from being considered, as the CSV file
-        # consistently receives a new timestamp during generation with operator-sdk 1.26 onwards.
-        git diff --exit-code --ignore-matching-lines createdAt || (echo -e '\e[31m'"$msg"; exit 1)
-
-  catalog-build:
-    runs-on: ubuntu-latest
-    strategy:
-      fail-fast: false
-      matrix:
-        go: ["1.20", "1.21"]
-    steps:
-    - uses: actions/setup-go@v4
-      with:
-        go-version: ${{ matrix.go }}
-
-    - uses: actions/checkout@v3
-      with:
-        fetch-depth: 0
-
-    - name: Build catalog docker image
-      env:
-        IMAGE_REGISTRY: localhost:5000
-        OPM_RENDER_OPTS: --use-http
-      run: |
-        docker run -d -p 5000:5000 --name registry registry:2
-        make bundle-build bundle-push catalog-build
diff --git a/.github/workflows/docker-push.yaml b/.github/workflows/docker-push.yaml
deleted file mode 100644
index a01c821f..00000000
--- a/.github/workflows/docker-push.yaml
+++ /dev/null
@@ -1,38 +0,0 @@
-name: image-publisher
-
-on:
-  workflow_dispatch:
-    inputs:
-      REGISTRY_NAMESPACE:
-        required: true
-        default: ocs-dev
-      IMAGE_TAG:
-        required: true
-        default: latest
-
-jobs:
-  docker-push:
-    runs-on: ubuntu-latest
-    steps:
-    - uses: actions/checkout@v3
-      with:
-        fetch-depth: 0
-
-    - uses: actions/setup-go@v4
-      with:
-        go-version-file: go.mod
-
-    - uses: docker/login-action@v2
-      with:
-        registry: quay.io
-        username: ${{ secrets.QUAY_USERNAME }}
-        password: ${{ secrets.QUAY_ROBOT_TOKEN }}
-
-    - name: Build and push docker images
-      env:
-        REGISTRY_NAMESPACE: ${{ github.event.inputs.REGISTRY_NAMESPACE }}
-        IMAGE_TAG: ${{ github.event.inputs.IMAGE_TAG }}
-      run: |
-        make docker-build docker-push
-        make bundle-build bundle-push
-        make catalog-build catalog-push
diff --git a/.github/workflows/golangci-lint.yaml b/.github/workflows/golangci-lint.yaml
deleted file mode 100644
index ca08c6d5..00000000
--- a/.github/workflows/golangci-lint.yaml
+++ /dev/null
@@ -1,25 +0,0 @@
----
-name: golangci-lint
-
-on:
-  push:
-    branches: ['main', 'release-*']
-  pull_request:
-    branches: ['*']
-
-jobs:
-  golangci-lint:
-    runs-on: ubuntu-latest
-    steps:
-    - uses: actions/checkout@v3
-      with:
-        fetch-depth: 0
-
-    - uses: actions/setup-go@v4
-      with:
-        go-version-file: go.mod
-
-    - uses: golangci/golangci-lint-action@v3
-      with:
-        version: v1.53.1
-        args: -E gosec --timeout=6m
diff --git a/.github/workflows/mirror-noobaa-upstream-images.yaml b/.github/workflows/mirror-noobaa-upstream-images.yaml
deleted file mode 100644
index 53ee51d0..00000000
--- a/.github/workflows/mirror-noobaa-upstream-images.yaml
+++ /dev/null
@@ -1,26 +0,0 @@
----
-name: mirror-noobaa-upstream-images
-
-on:
-  schedule:
-    - cron: "0 * * * *"
-
-jobs:
-  mirror-noobaa-upstream-images:
-    runs-on: ubuntu-latest
-    if: >
-      github.repository == 'red-hat-storage/odf-operator' &&
-      github.ref == 'refs/heads/main'
-    steps:
-    - uses: actions/checkout@v3
-      with:
-        fetch-depth: 0
-
-    - uses: docker/login-action@v2
-      with:
-        registry: quay.io
-        username: ${{ secrets.QUAY_USERNAME }}
-        password: ${{ secrets.QUAY_ROBOT_TOKEN }}
-
-    - name: mirror images
-      run: hack/mirror-noobaa-images.sh
diff --git a/.github/workflows/sync.yaml b/.github/workflows/sync.yaml
new file mode 100644
index 00000000..9078a7b1
--- /dev/null
+++ b/.github/workflows/sync.yaml
@@ -0,0 +1,37 @@
+name: Sync Upstream
+
+on:
+  schedule:
+    - cron: '0 0 * * *'
+  workflow_dispatch:
+
+env:
+  UPSTREAM_REPO: "github.com/red-hat-storage/odf-operator"
+
+jobs:
+  sync:
+    name: Sync Upstream
+    runs-on: ubuntu-latest
+
+    steps:
+      - name: Checkout
+        uses: actions/checkout@v2
+        with:
+          fetch-depth: 0
+          token: ${{ secrets.WORKFLOW_TOKEN }}
+
+      - name: Pull All Upstream Branches and push to origin
+        run: |
+          # Set git config
+          git config --global user.name "GitHub Actions"
+          git config --global user.email "41898282+github-actions@users.noreply.github.com"
+          git config --global checkout.defaultRemote "origin"
+          # Copy upstream patch out of working directory
+          cp upstream.patch ../upstream.patch
+          git remote add upstream https://${UPSTREAM_REPO}
+          git fetch upstream
+          git branch -r | grep 'upstream/release-[0-9]\.[0-9]\+$' | grep -v HEAD | while read line; do git checkout "${line#upstream/}"; git merge "upstream/${line#upstream/}"; done
+          git fetch --all
+          # Check if branch exists on remote, if not apply upstream.patch
+          git branch -r | grep 'upstream/release-[0-9]\.[0-9]\+$' | grep -v HEAD | while read line; do if [[ -z $(git ls-remote --heads origin "${line#upstream/}") ]]; then git checkout "${line#upstream/}"; git am --ignore-whitespace -3 < ../upstream.patch; fi; done
+          git push --all origin
\ No newline at end of file
diff --git a/.github/workflows/yamllint.yaml b/.github/workflows/yamllint.yaml
deleted file mode 100644
index dcc807eb..00000000
--- a/.github/workflows/yamllint.yaml
+++ /dev/null
@@ -1,19 +0,0 @@
----
-name: yamllint
-on:
-  push:
-    branches: ['main', 'release-*']
-  pull_request:
-    branches: ['*']
-jobs:
-  yamllint:
-    runs-on: ubuntu-latest
-    steps:
-    - uses: actions/checkout@v3
-      with:
-        fetch-depth: 0
-
-    - uses: ibiqlik/action-yamllint@v3
-      with:
-        config_file: ./.github/workflows/conf/yamllint.yaml
-        file_or_dir: .  # Recursive on all yaml files
